import{create_object}from"../common.js";import Index,{autoCommit}from"../index.js";import default_compress from"../compress.js";import{KeystoreArray}from"../keystore.js";Index.prototype.add=function(a,b,c,d){if(b&&(a||0===a)){if(!d&&!c&&this.reg.has(a))return this.update(a,b);b=this.encoder.encode(b);const e=b.length;if(e){const d=create_object(),f=create_object(),g=this.depth,h=this.resolution;for(let j=0;j<e;j++){let i=b[this.rtl?e-1-j:j],k=i.length;if(k&&(g||!f[i])){let l=this.score?this.score(b,i,j,null,0):get_score(h,e,j),m="";switch(this.tokenize){case"full":if(2<k){for(let d,g=0;g<k;g++)for(let l=k;l>g;l--){m=i.substring(g,l),d=this.rtl?k-1-g:g;const n=this.score?this.score(b,i,j,m,d):get_score(h,e,j,k,d);this.push_index(f,m,n,a,c)}break}case"bidirectional":case"reverse":if(1<k){for(let d=k-1;0<d;d--){m=i[this.rtl?k-1-d:d]+m;const g=this.score?this.score(b,i,j,m,d):get_score(h,e,j,k,d);this.push_index(f,m,g,a,c)}m=""}case"forward":if(1<k){for(let b=0;b<k;b++)m+=i[this.rtl?k-1-b:b],this.push_index(f,m,l,a,c);break}default:if(this.push_index(f,i,l,a,c),g&&1<e&&j<e-1){const f=create_object(),h=this.resolution_ctx,k=i,l=Math.min(g+1,this.rtl?j+1:e-j);f[k]=1;for(let g=1;g<l;g++)if(i=b[this.rtl?e-1-j-g:j+g],i&&!f[i]){f[i]=1;const m=this.score?this.score(b,k,j,i,g-1):get_score(h+(e/2>h?0:1),e,j,l-1,g-1),n=this.bidirectional&&i>k;this.push_index(d,n?k:i,m,a,c,n?i:k)}}}}}this.fastupdate||this.reg.add(a)}else b=""}return this.db&&(b||this.commit_task.push({del:a}),this.commit_auto&&autoCommit(this)),this},Index.prototype.push_index=function(a,b,c,d,e,f){let g,h=f?this.ctx:this.map;if((!a[b]||f&&!(g=a[b])[f])&&(f?(a=g||(a[b]=create_object()),a[f]=1,this.compress&&(f=default_compress(f)),g=h.get(f),g?h=g:h.set(f,h=new Map)):a[b]=1,this.compress&&(b=default_compress(b)),g=h.get(b),g?h=g:h.set(b,h=g=[]),h=h[c]||(h[c]=[]),!e||!h.includes(d))){if(2147483647===h.length){const a=new KeystoreArray(h);if(this.fastupdate)for(let b of this.reg.values())b.includes(h)&&(b[b.indexOf(h)]=a);g[c]=h=a}if(h.push(d),this.fastupdate){const a=this.reg.get(d);a?a.push(h):this.reg.set(d,[h])}}};function get_score(a,b,c,d,e){return c&&1<a?b+(d||0)<=a?c+(e||0):0|(a-1)/(b+(d||0))*(c+(e||0))+1:0}